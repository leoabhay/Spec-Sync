var HT_Chrono = [];
var HT_Ranking = [];
var HT_FilteredByCat = [];
var selectorCatEntryID = selectorCatEntryID ? selectorCatEntryID : false;
// Sorting method historyEngine.order('-visits.counter', '-visits.last.timestamp');
var historyEngine = (function(){
    // CONFIG OBJ
    var ct_history_config = {
        'date' : {
            'currentDate' : new Date(),
            'currentDate_timestamp' : Date.now(),
            'currentDate_human' : new Date(Date.now()).toLocaleString(),
            'currentDate_number' : new Date().getFullYear()+''+(('0' + (new Date().getMonth() + 1)).slice(-2))+''+('0' + new Date().getDate()).slice(-2),
        },
        'userData' : {
            'getUsername' : false,
            'takeUsernameFrom' : '.oo-hdr-username',
        },
        'setting' : {
            'ranking' : {
                'scroll' : {
                    'averageScroll' : window.innerHeight / 2,
                    'value' : 1,
                },
                'addToCart' : 1,
                'slide' : 1,
            }
        }
    }
    //Variabili instanziate
    var ct_history;
    //1. Verifico l'arrivo di utag e faccio cil check della local storage.
    var start = function(){
        return new Promise(function (resolve, reject) {
            var controll = 0;
            var utchecker = setInterval(
                function(){
                    controll++;
                    if(controll < 10){
                        if(utag_data.Page_Type){
                            if(utag_data.Page_Type == 'Pdp' || utag_data.Page_Type == 'Pcp'){
                                if(utag_data.Products){
                                    clearInterval(utchecker);
                                    checklocalstorage();
                                    resolve();
                                }
                            } else {
                                checklocalstorage();
                                resolve();
                                clearInterval(utchecker);
                            }
                        }
                    } else {
                        clearInterval(utchecker);
                        reject();
                        return;
                    }
                }, 1000
            );
        })
    };


    //2. verifico nella local storage se è già presente il mio oggetto.
    var checklocalstorage = function(){
        var thereIsLocalStorage = (localStorage.getItem('pdpH') != null) ? true : false;
        var getLocalStorage = thereIsLocalStorage ? JSON.parse(localStorage.getItem('pdpH')) : false;
        ct_history = {
            'user' : {
                'status' : thereIsLocalStorage ? getLocalStorage.user.status : '',
                'name' :  thereIsLocalStorage ? getLocalStorage.user.name : '',
                'visits' : {
                    'prev' : thereIsLocalStorage ? getLocalStorage.user.visits.prev : '',
                    'last' : thereIsLocalStorage ? getLocalStorage.user.visits.last : '',
                },
                'loveCategory' : thereIsLocalStorage ? getLocalStorage.user.loveCategory : [],
            },
            'purchasedProducts' : thereIsLocalStorage ? (getLocalStorage.purchasedProducts ? getLocalStorage.purchasedProducts : []) : [], 
            'products' : thereIsLocalStorage ? getLocalStorage.products : [],
            'orderBy' : {
                // 'ranking' : thereIsLocalStorage ? getLocalStorage.orderBy.ranking : [], //ordina per numero di visite e last visit
                'chrono' : thereIsLocalStorage ? getLocalStorage.orderBy.chrono : [],
                // 'mostViewed' : thereIsLocalStorage ? getLocalStorage.orderBy.mostViewed : [],
            },
            'pages' : thereIsLocalStorage ? getLocalStorage.pages : {},
            'productsCategory' : thereIsLocalStorage ? getLocalStorage.productsCategory : {},
        };
        HT_Chrono = thereIsLocalStorage ? getLocalStorage.orderBy.chrono : [];
        HT_Ranking = thereIsLocalStorage ? getLocalStorage.products : [];

        //2.2 verifico lo status dell'utente
        checkUserStatus();
    };


    //3. popolo il nodo user dell'oggetto
    var checkUserStatus = function(){
        //3.1 verifico lo status dell'utente e se loggato lo salvo
        if(utag_data.User_LoginStatus == 'Logged'){
            ct_history.user.status = 'Logged';
            if(ct_history_config.userData.getUsername){
                ct_history.user.name = document.querySelector(ct_history_config.userData.takeUsernameFrom).innerText;
            }
        } else {
            ct_history.user.status = 'Guest';
        }
        //3.2 verifico se l'ultima visita è avvenuta in data precedente a quella corrente
        if(parseInt(ct_history.user.visits.last) < parseInt(ct_history_config.date.currentDate_number) ){
            ct_history.user.visits.prev = ct_history.user.visits.last;
        }
        ct_history.user.visits.last = ct_history_config.date.currentDate_number;
        //3.3 faccio partire la verifica della tipologia di pagina
        checkpagetype();
    };


    //4. verifico la tipologia di pagina
    var checkpagetype = function(){
        if(utag_data.Page_Type == 'Pdp' || utag_data.Page_Type == 'Pcp'){
            //4.1 se sono in PDP o PCP (prodotti custom) inizio il tracking dei prodotti
            startTrackingProducts();
        } else if(utag_data.Page_Type == 'Thankyou'){
            checkPurchasedProduct();
        } else{
            //4.2 se sono in qualsiasi altra pagina inizio il tracking della navigazione
            startTrackingPages();
        }
    }


    //5. inizio a tracciare le pagine
    var startTrackingPages = function(){
        var currentPage = {
            'pagename' : utag_data.Page_Name,
            'lastvisit' : ct_history_config.date.currentDate_number,
        };
        if(ct_history.pages[utag_data.Page_Type]){
            ct_history.pages[utag_data.Page_Type].push(currentPage);
        } else {
            ct_history.pages[utag_data.Page_Type] = [];
            ct_history.pages[utag_data.Page_Type].push(currentPage);
        }
        setLocalStorage();
    }

    //5. inizio a tracciare le pagine
    var checkPurchasedProduct = function(){
        Object.keys(utag_data.Products).forEach(function(item){
            if(ct_history.purchasedProducts.indexOf(item.split('#')[0]) == -1){
                ct_history.purchasedProducts.push(item.split('#')[0]);
            }
        });
        setLocalStorage();
    }


    //5. inizio a tracciare i prodotti
    var startTrackingProducts = function(){

        /**
         * Recupero il 'itemCatentryId' in quanto su RB non è possibile avere i dati aggiornati
         * senza questo valore
         */
        var currentCatEntryID = selectorCatEntryID ? selectorCatEntryID : undefined;

        var currentProductUPC = Object.keys(utag_data.Products).toString();
        var currentProductInfo = utag_data.Products[currentProductUPC];
        var currentProductCategory = currentProductInfo.Category;
        if(ct_history.products.length > 0){
            var hasMatch = ct_history.products.filter(function (product) {
                return (product.upc === currentProductUPC);
            }).length > 0;
            if(hasMatch){
                var proceed = true;
                ct_history.products.forEach(function(product,i){
                    if(product.upc === currentProductUPC && proceed){
                        proceed = false;
                        product.modelName = currentProductInfo.ModelName;
                        product.url = currentProductInfo.Url;
                        product.visits.counter = product.visits.counter + 1;
                        product.visits.prev.timestamp = product.visits.last.timestamp;
                        product.visits.prev.fullDate = product.visits.last.fullDate;
                        product.visits.last.timestamp = ct_history_config.date.currentDate_timestamp;
                        product.visits.last.fullDate = ct_history_config.date.currentDate_number;
                        product.catentryId = currentCatEntryID;
                        if(ct_history.purchasedProducts.indexOf(product.upc) > -1){
                            product.purchased = true;
                        } else {
                            product.purchased = false;
                        }
                        ct_history.products.push(
                            ct_history.products.splice(i, 1)[0]
                        );
                    } else {
                    }
                });
            } else {
                generateProduct(currentProductInfo, currentProductUPC, currentCatEntryID);
            }
        } else {
            generateProduct(currentProductInfo, currentProductUPC, currentCatEntryID);
        }

        if(ct_history.productsCategory[currentProductCategory]){
            ct_history.productsCategory[currentProductCategory] = ct_history.productsCategory[currentProductCategory] + 1;
        } else {
            ct_history.productsCategory[currentProductCategory] = 1;
            ct_history.productsCategory[currentProductCategory] = 1;
        }
        generateChrono();
        generateRanking(currentProductUPC);
        checkLoveCategory();
    };


    //5.A Genero il prodotto
    var generateProduct = function(currentProductInfo, currentProductUPC, currentCatEntryID){
        var isDiscounted = (parseInt(currentProductInfo.PriceFull) > parseInt(currentProductInfo.Price)) ? true : false;
        var product = {
            'upc': currentProductUPC, 
            'sku' : currentProductInfo.Sku,
            'catentryId' : currentCatEntryID,
            'modelName' : currentProductInfo.ModelName,
            'modelFamily' : currentProductInfo.ModelCode, 
            'url' : currentProductInfo.Url,
            'category' : currentProductInfo.Category,
            'price': currentProductInfo.Price,
            'priceFull': currentProductInfo.PriceFull,
            'isDiscounted' : isDiscounted,
            'status': currentProductInfo.Status,
            'stock' : currentProductInfo.Stock, 
            'purchased': false,
            'addedToCart' : false,
            'visits' : {
                'counter' : 1,
                'prev' : {
                    'timestamp' : false,
                    'fullDate' : false,
                },
                'last' : {
                    'timestamp' : ct_history_config.date.currentDate_timestamp,
                    'fullDate' : ct_history_config.date.currentDate_number,
                }
            },
            'ranking' : 1,
        };
        ct_history.products.push(product);
    }


    //5.B genero la cronologia
    var generateChrono = function(){
        var orderChrono = JSON.parse(JSON.stringify(ct_history.products)).reverse();
        ct_history.orderBy.chrono = orderChrono;
        HT_Chrono = orderChrono;
    }


    //5.B traccio le azioni sulla PDP
    var generateRanking = function(currentProductUPC){
        //variabili di controllo

        //click add to cart

        //scroll in pagina
        var addOnScroll = true;
        //TODO scroll event
        // window.addEventListener('scroll', (event) => {
        //     if(addOnScroll){
        //         if(this.scrollY > parseInt(ct_history_config.setting.ranking.scroll.averageScroll) ){
        //             addOnScroll = false;
        //             checkAndEdit(currentProductUPC)
        //         }
        //     }
        // });
    }
    //5.C Ordino i prodotti in base al ranking
    // var checkAndEdit = function(currentProductUPC){
    //     var rankingHasMatch = ct_history.orderBy.ranking.filter(function (singleProd) {
    //         return (singleProd.upc === currentProductUPC);
    //     }).length > 0;
    //     if(rankingHasMatch){
    //         var updateRanking = ct_history.orderBy.ranking.filter((product) => {
    //             if(product.upc === currentProductUPC){
    //                 product.visits.counter = product.visits.counter + 1;
    //             }
    //             return product;
    //         });
    //         ct_history.orderBy.ranking = updateRanking;
    //     }
    //     setLocalStorage();
    // }


    //6. Verifico la categoria preferita
    var checkLoveCategory = function(){
        var sortableCategory = [];
        for (var category in ct_history.productsCategory) {
            sortableCategory.push([category, ct_history.productsCategory[category]]);
        }
        var sorted = sortableCategory.sort(function(a, b) {
            return b[1] - a[1];
        });
        ct_history.user.loveCategory = sorted[0][0];
        setLocalStorage();
    }

    //UTILS
    
    var orderProduct = function(...args){
        HT_Ranking.sort(sortProductList(...args ));
    }

    var sortProductList = function(){
        var arrArgs = Array.prototype.slice.call(arguments);
        return function(a, b){
            for(var x in arrArgs){
                var arg = arrArgs[x].substring(1)
                var ax = eval('a.'+ arg)
                var bx = eval('b.'+ arg)
                var cx;
    
                ax = typeof ax == "string" ? ax.toLowerCase() : ax / 1;
                bx = typeof bx == "string" ? bx.toLowerCase() : bx / 1;
    
                if(arrArgs[x].substring(0,1) == "-"){cx = ax; ax = bx; bx = cx;}
                if(ax != bx){return ax < bx ? -1 : 1;}
            }
        }
    }
    
    var filterProductsCategory = function(category){
        HT_FilteredByCat = JSON.parse(JSON.stringify(HT_Ranking))
        var filteredProduct = HT_FilteredByCat.filter(function (product) {
            return product.category == category;
        });
        HT_FilteredByCat = filteredProduct;
    }

    //7. Setto l'oggeto in local storage
    var setLocalStorage = function(){
        localStorage.setItem('pdpH',JSON.stringify(ct_history));
    };

    return {
        init: start,
        order: orderProduct,
        filterBy: filterProductsCategory,
    };
})(); 